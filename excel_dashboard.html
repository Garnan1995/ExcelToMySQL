<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Web Application - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            backdrop-filter: blur(10px);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #217346 0%, #2a9d5c 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-actions select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .header-actions select option {
            background: #217346;
        }

        .header-actions button {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .header-actions button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        /* Sheet Tabs */
        .sheet-tabs {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 0 24px;
            display: flex;
            gap: 4px;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .sheet-tab {
            padding: 10px 24px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            cursor: pointer;
            position: relative;
            top: 2px;
            transition: all 0.3s;
            font-size: 14px;
            border-radius: 8px 8px 0 0;
        }

        .sheet-tab:hover {
            background: #e8f0fe;
        }

        .sheet-tab.active {
            background: white;
            border-bottom: 2px solid white;
            font-weight: 600;
            color: #217346;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 12px 24px;
            display: flex;
            gap: 24px;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .formula-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-grow: 1;
        }

        .cell-reference {
            background: #f8f9fa;
            padding: 8px 16px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            min-width: 80px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .formula-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .formula-input:focus {
            outline: none;
            border-color: #217346;
            box-shadow: 0 0 0 3px rgba(33, 115, 70, 0.1);
        }

        .apply-btn {
            padding: 8px 16px;
            background: #217346;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .apply-btn:hover {
            background: #2a9d5c;
            transform: translateY(-1px);
        }

        /* Excel Grid */
        .excel-container {
            background: white;
            margin: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            overflow: auto;
            height: calc(100vh - 280px);
            position: relative;
        }

        .excel-grid {
            border-collapse: collapse;
            font-size: 13px;
            position: relative;
            width: 100%;
        }

        .excel-grid th {
            background: linear-gradient(to bottom, #f8f9fa, #f0f1f3);
            border: 1px solid #dadce0;
            padding: 8px 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 100px;
            text-align: center;
            font-weight: 500;
            color: #5f6368;
        }

        .excel-grid th.row-header {
            position: sticky;
            left: 0;
            z-index: 11;
            min-width: 50px;
            background: linear-gradient(to right, #f8f9fa, #f0f1f3);
        }

        .excel-grid td {
            border: 1px solid #e0e0e0;
            padding: 0;
            min-width: 100px;
            height: 32px;
            position: relative;
            background: white;
            transition: background-color 0.2s;
        }

        .excel-grid td.row-header {
            background: linear-gradient(to right, #f8f9fa, #f0f1f3);
            text-align: center;
            font-weight: 500;
            color: #5f6368;
            position: sticky;
            left: 0;
            z-index: 9;
            padding: 8px;
        }

        /* Cell Styles */
        .cell {
            width: 100%;
            height: 100%;
            border: none;
            padding: 6px 8px;
            font-size: 13px;
            outline: none;
            background: transparent;
            font-family: inherit;
        }

        .cell:focus {
            outline: 2px solid #1a73e8;
            outline-offset: -2px;
            background: #f8f9fa;
        }

        .cell.formula {
            color: #1a73e8;
            font-style: italic;
        }

        .cell.dropdown {
            background: linear-gradient(to bottom, #fffef7, #fffdf0);
            cursor: pointer;
            padding-right: 28px;
            font-weight: 500;
        }

        .dropdown-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #5f6368;
            font-size: 12px;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #dadce0;
        }

        /* Cell States */
        .cell-highlight {
            background: linear-gradient(to bottom, #e8f0fe, #dce7fc) !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .cell-dependent {
            background: linear-gradient(to bottom, #f0f8ff, #e6f3ff) !important;
        }

        .cell-error {
            background: linear-gradient(to bottom, #fee, #fdd) !important;
            color: #d00;
            font-weight: 600;
        }

        .cell-updating {
            background: linear-gradient(to bottom, #fff3cd, #ffeaa7) !important;
            animation: updating 0.5s infinite;
        }

        @keyframes updating {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 200px;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-search {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .dropdown-search input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 13px;
        }

        .dropdown-item {
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-item:hover {
            background: linear-gradient(to right, #f8f9fa, #f0f1f3);
            padding-left: 18px;
        }

        .dropdown-item.selected {
            background: linear-gradient(to right, #e8f0fe, #dce7fc);
            font-weight: 600;
            color: #1a73e8;
        }

        .dropdown-item.selected::before {
            content: '✓';
            color: #1a73e8;
            font-weight: bold;
        }

        /* Status Bar */
        .status-bar {
            background: linear-gradient(to bottom, #f8f9fa, #f0f1f3);
            padding: 8px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #dadce0;
            font-size: 12px;
            color: #5f6368;
        }

        .status-left {
            display: flex;
            gap: 24px;
        }

        .status-item {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .status-item strong {
            color: #202124;
            font-size: 13px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34a853;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner-container {
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #217346;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        .loading-text {
            color: #5f6368;
            font-size: 14px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideUp 0.3s ease-out;
            z-index: 1000;
        }

        .notification.show {
            display: flex;
        }

        .notification.success {
            border-left: 4px solid #34a853;
        }

        .notification.error {
            border-left: 4px solid #ea4335;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                Excel Web Application
            </h1>
            <div class="header-actions">
                <select id="workbookSelect" onchange="loadWorkbook(this.value)">
                    <option value="">Select Workbook...</option>
                </select>
                <button onclick="recalculateAll()">
                    <span style="margin-right: 4px;">♻️</span> Recalculate All
                </button>
                <button onclick="saveChanges()">
                    <span style="margin-right: 4px;">💾</span> Save
                </button>
            </div>
        </div>

        <!-- Sheet Tabs -->
        <div class="sheet-tabs" id="sheetTabs"></div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="formula-bar">
                <div class="cell-reference" id="cellReference">A1</div>
                <span style="color: #5f6368; font-size: 16px;">ƒx</span>
                <input type="text" class="formula-input" id="formulaInput" 
                       placeholder="Enter formula or value..." 
                       onkeypress="if(event.key==='Enter') applyFormula()">
                <button class="apply-btn" onclick="applyFormula()">Apply</button>
            </div>
        </div>

        <!-- Excel Grid -->
        <div class="excel-container">
            <table class="excel-grid" id="excelGrid"></table>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <div class="status-indicator"></div>
                    <span>Status:</span>
                    <strong id="status">Ready</strong>
                </div>
                <div class="status-item">
                    <span>Cells:</span>
                    <strong id="cellCount">0</strong>
                </div>
                <div class="status-item">
                    <span>Formulas:</span>
                    <strong id="formulaCount">0</strong>
                </div>
            </div>
            <div class="status-right">
                <span id="lastUpdate">Last updated: Never</span>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu" style="display: none;">
        <div class="dropdown-search">
            <input type="text" placeholder="Search..." id="dropdownSearch" onkeyup="filterDropdown()">
        </div>
        <div id="dropdownItems"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // ============================================
        // Global State Management
        // ============================================
        const AppState = {
            currentWorkbook: null,
            currentSheet: null,
            sheets: [],
            cells: {},
            formulas: {},
            dependencies: {},
            validations: [],
            selectedCell: null,
            isDirty: false,
            updateQueue: new Set(),
            validationCache: {},
            isUpdating: false
        };

        // ============================================
        // Initialization
        // ============================================
        window.onload = function() {
            loadWorkbooks();
            setupEventListeners();
        };

        function setupEventListeners() {
            // Global click handler for closing dropdowns
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdownMenu');
                if (!dropdown.contains(e.target) && 
                    !e.target.classList.contains('dropdown')) {
                    dropdown.style.display = 'none';
                }
            });

            // Save on Ctrl+S
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveChanges();
                }
            });
        }

        // ============================================
        // Data Loading Functions
        // ============================================
        async function loadWorkbooks() {
            try {
                const response = await fetch('api/get_workbooks.php');
                const workbooks = await response.json();
                
                const select = document.getElementById('workbookSelect');
                select.innerHTML = '<option value="">Select Workbook...</option>';
                
                workbooks.forEach(wb => {
                    const option = document.createElement('option');
                    option.value = wb.id;
                    option.textContent = wb.filename;
                    select.appendChild(option);
                });
                
                if (workbooks.length > 0) {
                    loadWorkbook(workbooks[0].id);
                }
            } catch (error) {
                showNotification('Error loading workbooks', 'error');
                console.error('Error loading workbooks:', error);
            }
        }

        async function loadWorkbook(workbookId) {
            if (!workbookId) return;
            
            showLoading(true, 'Loading workbook...');
            AppState.currentWorkbook = workbookId;
            
            try {
                const response = await fetch(`api/get_sheets.php?workbook_id=${workbookId}`);
                AppState.sheets = await response.json();
                
                renderSheetTabs();
                
                if (AppState.sheets.length > 0) {
                    await loadSheet(AppState.sheets[0].id);
                }
            } catch (error) {
                showNotification('Error loading workbook', 'error');
                console.error('Error loading workbook:', error);
            } finally {
                showLoading(false);
            }
        }

        async function loadSheet(sheetId) {
            showLoading(true, 'Loading sheet data...');
            AppState.currentSheet = sheetId;
            
            // Update active tab
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.getElementById(`sheet-tab-${sheetId}`);
            if (activeTab) activeTab.classList.add('active');
            
            try {
                // Load cells and validations in parallel
                const [cellsResponse, validationsResponse] = await Promise.all([
                    fetch(`api/get_cells.php?sheet_id=${sheetId}`),
                    fetch(`api/get_validations.php?sheet_id=${sheetId}`)
                ]);
                
                const cellData = await cellsResponse.json();
                AppState.validations = await validationsResponse.json();
                
                processCellData(cellData);
                processValidations();
                renderGrid();
                updateStatus();
                
            } catch (error) {
                showNotification('Error loading sheet', 'error');
                console.error('Error loading sheet:', error);
            } finally {
                showLoading(false);
            }
        }

        // ============================================
        // Data Processing
        // ============================================
        function processCellData(cellData) {
            AppState.cells = {};
            AppState.formulas = {};
            AppState.dependencies = {};
            
            cellData.forEach(cell => {
                const key = cell.cell_address;
                AppState.cells[key] = cell;
                
                if (cell.formula) {
                    AppState.formulas[key] = cell.formula;
                    
                    if (cell.dependencies) {
                        try {
                            const deps = JSON.parse(cell.dependencies);
                            AppState.dependencies[key] = deps;
                            
                            // Build reverse dependencies
                            deps.forEach(dep => {
                                if (!AppState.dependencies[dep]) {
                                    AppState.dependencies[dep] = [];
                                }
                                if (!AppState.dependencies[dep].includes(key)) {
                                    AppState.dependencies[dep].push(key);
                                }
                            });
                        } catch (e) {
                            console.error('Error parsing dependencies:', e);
                        }
                    }
                }
            });
        }

        function processValidations() {
            AppState.validationCache = {};
            
            AppState.validations.forEach(validation => {
                // Cache validation data for quick lookup
                const cells = parseCellRange(validation.cell_range);
                cells.forEach(cell => {
                    AppState.validationCache[cell] = validation;
                });
            });
        }

        function parseCellRange(range) {
            // Simple parser for single cells or ranges like D4:D10
            const cells = [];
            
            if (range.includes(':')) {
                const [start, end] = range.split(':');
                const startMatch = start.match(/([A-Z]+)(\d+)/);
                const endMatch = end.match(/([A-Z]+)(\d+)/);
                
                if (startMatch && endMatch) {
                    const startCol = columnToNumber(startMatch[1]);
                    const endCol = columnToNumber(endMatch[1]);
                    const startRow = parseInt(startMatch[2]);
                    const endRow = parseInt(endMatch[2]);
                    
                    for (let row = startRow; row <= endRow; row++) {
                        for (let col = startCol; col <= endCol; col++) {
                            cells.push(numberToColumn(col) + row);
                        }
                    }
                }
            } else {
                cells.push(range);
            }
            
            return cells;
        }

        // ============================================
        // Grid Rendering
        // ============================================
        function renderGrid() {
            const grid = document.getElementById('excelGrid');
            grid.innerHTML = '';
            
            // Calculate dimensions
            let maxRow = 50;
            let maxCol = 26;
            
            Object.keys(AppState.cells).forEach(addr => {
                const match = addr.match(/([A-Z]+)(\d+)/);
                if (match) {
                    const col = match[1];
                    const row = parseInt(match[2]);
                    maxRow = Math.max(maxRow, row);
                    maxCol = Math.max(maxCol, columnToNumber(col));
                }
            });
            
            // Create header row
            const headerRow = document.createElement('tr');
            const cornerCell = document.createElement('th');
            cornerCell.className = 'row-header';
            headerRow.appendChild(cornerCell);
            
            for (let col = 1; col <= maxCol; col++) {
                const th = document.createElement('th');
                th.textContent = numberToColumn(col);
                headerRow.appendChild(th);
            }
            grid.appendChild(headerRow);
            
            // Create data rows
            for (let row = 1; row <= maxRow; row++) {
                const tr = document.createElement('tr');
                
                // Row header
                const rowHeader = document.createElement('td');
                rowHeader.className = 'row-header';
                rowHeader.textContent = row;
                tr.appendChild(rowHeader);
                
                // Data cells
                for (let col = 1; col <= maxCol; col++) {
                    const cellAddr = numberToColumn(col) + row;
                    const td = createTableCell(cellAddr);
                    tr.appendChild(td);
                }
                
                grid.appendChild(tr);
            }
        }

        function createTableCell(cellAddr) {
            const td = document.createElement('td');
            const cellData = AppState.cells[cellAddr];
            const validation = AppState.validationCache[cellAddr];
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'cell';
            input.id = `input-${cellAddr}`;
            
            if (cellData) {
                input.value = cellData.formatted_value || cellData.value || '';
                
                if (cellData.formula) {
                    input.classList.add('formula');
                    input.title = cellData.formula;
                    td.classList.add('cell-dependent');
                }
                
                if (cellData.error_message) {
                    input.classList.add('cell-error');
                    input.value = cellData.error_message;
                }
            }
            
            // Event handlers
            input.onfocus = () => selectCell(cellAddr);
            input.onchange = () => updateCell(cellAddr, input.value);
            input.onkeydown = (e) => handleCellKeydown(e, cellAddr);
            
            // Add dropdown functionality if validation exists
            if (validation) {
                input.classList.add('dropdown');
                input.onclick = (e) => {
                    e.stopPropagation();
                    showDropdown(cellAddr, input);
                };
                input.readOnly = true;
                
                const arrow = document.createElement('span');
                arrow.className = 'dropdown-arrow';
                arrow.textContent = '▼';
                td.appendChild(arrow);
            }
            
            td.appendChild(input);
            td.id = `cell-${cellAddr}`;
            
            return td;
        }

        // ============================================
        // Dropdown Management - FIXED
        // ============================================
        async function showDropdown(cellAddr, input) {
            const validation = AppState.validationCache[cellAddr];
            if (!validation) return;
            
            const menu = document.getElementById('dropdownMenu');
            const itemsContainer = document.getElementById('dropdownItems');
            itemsContainer.innerHTML = '';
            
            // Get dropdown items
            let items = await getValidationItems(validation);
            
            if (items.length === 0) {
                items = ['No options available'];
            }
            
            // Store items for filtering
            menu.dataset.items = JSON.stringify(items);
            menu.dataset.cellAddr = cellAddr;
            
            // Create dropdown items
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = String(item);
                
                if (input.value === String(item)) {
                    div.classList.add('selected');
                }
                
                div.onclick = async () => {
                    // Update the input immediately for visual feedback
                    input.value = String(item);
                    input.classList.add('cell-updating');
                    
                    // Close dropdown
                    menu.style.display = 'none';
                    
                    // Update cell and trigger recalculation
                    await updateCell(cellAddr, String(item));
                    
                    // Remove updating class
                    input.classList.remove('cell-updating');
                };
                
                itemsContainer.appendChild(div);
            });
            
            // Position and show dropdown
            const rect = input.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = rect.bottom + 'px';
            menu.style.display = 'block';
            
            // Focus search input
            document.getElementById('dropdownSearch').value = '';
            document.getElementById('dropdownSearch').focus();
        }

        async function getValidationItems(validation) {
            let items = [];
            
            // Try to parse validation_list first
            if (validation.validation_list) {
                try {
                    const parsed = JSON.parse(validation.validation_list);
                    if (Array.isArray(parsed)) {
                        items = parsed;
                    }
                } catch (e) {
                    // Try comma-separated
                    items = validation.validation_list.split(',').map(item => item.trim());
                }
            }
            
            // If no items yet, try validation_formula (range reference)
            if (items.length === 0 && validation.validation_formula) {
                const match = validation.validation_formula.match(/(?:'([^']+)'!)?([A-Z$]+\d+:[A-Z$]+\d+)/);
                if (match) {
                    const sheetName = match[1];
                    const range = match[2];
                    
                    try {
                        const response = await fetch(
                            `api/get_range_values.php?sheet=${encodeURIComponent(sheetName)}&range=${encodeURIComponent(range)}`
                        );
                        const data = await response.json();
                        if (data.values) {
                            items = data.values;
                        }
                    } catch (e) {
                        console.error('Error fetching range values:', e);
                    }
                }
            }
            
            return items;
        }

        function filterDropdown() {
            const search = document.getElementById('dropdownSearch').value.toLowerCase();
            const menu = document.getElementById('dropdownMenu');
            const items = JSON.parse(menu.dataset.items || '[]');
            const itemsContainer = document.getElementById('dropdownItems');
            const cellAddr = menu.dataset.cellAddr;
            const input = document.getElementById(`input-${cellAddr}`);
            
            itemsContainer.innerHTML = '';
            
            const filtered = items.filter(item => 
                String(item).toLowerCase().includes(search)
            );
            
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = String(item);
                
                if (input.value === String(item)) {
                    div.classList.add('selected');
                }
                
                div.onclick = async () => {
                    input.value = String(item);
                    input.classList.add('cell-updating');
                    menu.style.display = 'none';
                    await updateCell(cellAddr, String(item));
                    input.classList.remove('cell-updating');
                };
                
                itemsContainer.appendChild(div);
            });
        }

        // ============================================
        // Cell Updates and Recalculation - FIXED
        // ============================================
        async function updateCell(cellAddr, value) {
            if (AppState.isUpdating) return;
            AppState.isUpdating = true;
            
            showLoading(true, 'Updating...');
            updateStatus('Updating cell...');
            
            try {
                const isFormula = value.startsWith('=');
                
                // Send update to server
                const response = await fetch('api/update_cell.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheet_id: AppState.currentSheet,
                        cell_address: cellAddr,
                        value: value,
                        is_formula: isFormula
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local state
                    AppState.cells[cellAddr] = result.cell;
                    AppState.isDirty = true;
                    
                    // Update display immediately
                    updateCellDisplay(cellAddr, result.cell);
                    
                    // Recalculate dependent cells
                    if (result.affected_cells && result.affected_cells.length > 0) {
                        await recalculateCells(result.affected_cells);
                    }
                    
                    // Update timestamp
                    updateTimestamp();
                    
                    // Show success feedback
                    showNotification('Cell updated successfully', 'success');
                    
                    // Highlight dependent cells briefly
                    highlightDependents(cellAddr);
                } else {
                    throw new Error(result.error || 'Update failed');
                }
                
            } catch (error) {
                console.error('Error updating cell:', error);
                showNotification('Error updating cell: ' + error.message, 'error');
            } finally {
                AppState.isUpdating = false;
                showLoading(false);
                updateStatus('Ready');
            }
        }

        async function recalculateCells(cellAddresses) {
            if (!cellAddresses || cellAddresses.length === 0) return;
            
            updateStatus('Recalculating formulas...');
            
            try {
                const response = await fetch('api/recalculate.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheet_id: AppState.currentSheet,
                        cells: cellAddresses
                    })
                });
                
                const results = await response.json();
                
                if (Array.isArray(results)) {
                    // Update all recalculated cells
                    results.forEach(result => {
                        AppState.cells[result.cell_address] = result;
                        updateCellDisplay(result.cell_address, result);
                    });
                    
                    // Check for cascading updates
                    const nextLevel = [];
                    results.forEach(result => {
                        if (AppState.dependencies[result.cell_address]) {
                            nextLevel.push(...AppState.dependencies[result.cell_address]);
                        }
                    });
                    
                    // Recursively recalculate next level if needed
                    if (nextLevel.length > 0) {
                        const unique = [...new Set(nextLevel)];
                        await recalculateCells(unique);
                    }
                }
            } catch (error) {
                console.error('Error recalculating:', error);
            }
        }

        function updateCellDisplay(cellAddr, cellData) {
            const input = document.getElementById(`input-${cellAddr}`);
            const cell = document.getElementById(`cell-${cellAddr}`);
            
            if (input) {
                // Update value
                input.value = cellData.formatted_value || cellData.value || '';
                
                // Update classes
                input.classList.toggle('formula', !!cellData.formula);
                input.classList.toggle('cell-error', !!cellData.error_message);
                
                if (cellData.formula) {
                    input.title = cellData.formula;
                    if (cell) cell.classList.add('cell-dependent');
                } else {
                    if (cell) cell.classList.remove('cell-dependent');
                }
                
                // Flash animation for updated cells
                input.classList.add('cell-updating');
                setTimeout(() => {
                    input.classList.remove('cell-updating');
                }, 500);
            }
        }

        // ============================================
        // Cell Selection and Navigation
        // ============================================
        function selectCell(cellAddr) {
            AppState.selectedCell = cellAddr;
            document.getElementById('cellReference').textContent = cellAddr;
            
            const cellData = AppState.cells[cellAddr];
            const formulaInput = document.getElementById('formulaInput');
            
            if (cellData && cellData.formula) {
                formulaInput.value = cellData.formula;
            } else if (cellData) {
                formulaInput.value = cellData.value || '';
            } else {
                formulaInput.value = '';
            }
            
            highlightDependencies(cellAddr);
        }

        function highlightDependencies(cellAddr) {
            // Clear previous highlights
            document.querySelectorAll('.cell-highlight').forEach(el => {
                el.classList.remove('cell-highlight');
            });
            
            // Highlight cells this cell depends on
            if (AppState.formulas[cellAddr]) {
                const formula = AppState.formulas[cellAddr];
                const refs = extractCellReferences(formula);
                refs.forEach(ref => {
                    const td = document.getElementById(`cell-${ref}`);
                    if (td) td.classList.add('cell-highlight');
                });
            }
        }

        function highlightDependents(cellAddr) {
            if (AppState.dependencies[cellAddr]) {
                AppState.dependencies[cellAddr].forEach(dep => {
                    const td = document.getElementById(`cell-${dep}`);
                    if (td) {
                        td.classList.add('cell-highlight');
                        setTimeout(() => {
                            td.classList.remove('cell-highlight');
                        }, 2000);
                    }
                });
            }
        }

        function extractCellReferences(formula) {
            const refs = [];
            const pattern = /\b([A-Z]+\d+)\b/g;
            let match;
            while ((match = pattern.exec(formula)) !== null) {
                refs.push(match[1]);
            }
            return refs;
        }

        function handleCellKeydown(e, cellAddr) {
            const match = cellAddr.match(/([A-Z]+)(\d+)/);
            if (!match) return;
            
            const col = columnToNumber(match[1]);
            const row = parseInt(match[2]);
            let newAddr = null;
            
            switch(e.key) {
                case 'ArrowUp':
                    if (row > 1) newAddr = numberToColumn(col) + (row - 1);
                    break;
                case 'ArrowDown':
                    newAddr = numberToColumn(col) + (row + 1);
                    break;
                case 'ArrowLeft':
                    if (col > 1) newAddr = numberToColumn(col - 1) + row;
                    break;
                case 'ArrowRight':
                    newAddr = numberToColumn(col + 1) + row;
                    break;
                case 'Enter':
                    if (!e.shiftKey) {
                        newAddr = numberToColumn(col) + (row + 1);
                    }
                    break;
                case 'Tab':
                    e.preventDefault();
                    if (!e.shiftKey) {
                        newAddr = numberToColumn(col + 1) + row;
                    } else if (col > 1) {
                        newAddr = numberToColumn(col - 1) + row;
                    }
                    break;
            }
            
            if (newAddr) {
                e.preventDefault();
                const input = document.getElementById(`input-${newAddr}`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }
        }

        // ============================================
        // Sheet Management
        // ============================================
        function renderSheetTabs() {
            const container = document.getElementById('sheetTabs');
            container.innerHTML = '';
            
            AppState.sheets.forEach(sheet => {
                const tab = document.createElement('div');
                tab.className = 'sheet-tab';
                tab.textContent = sheet.sheet_name;
                tab.onclick = () => loadSheet(sheet.id);
                tab.id = `sheet-tab-${sheet.id}`;
                container.appendChild(tab);
            });
        }

        // ============================================
        // Recalculation Functions
        // ============================================
        async function recalculateAll() {
            showLoading(true, 'Recalculating all formulas...');
            updateStatus('Recalculating all formulas...');
            
            try {
                const formulaCells = Object.keys(AppState.formulas);
                
                if (formulaCells.length === 0) {
                    showNotification('No formulas to recalculate', 'success');
                    return;
                }
                
                await recalculateCells(formulaCells);
                
                updateStatus('Recalculation complete');
                showNotification('All formulas recalculated', 'success');
                updateTimestamp();
                
            } catch (error) {
                console.error('Error recalculating all:', error);
                showNotification('Error during recalculation', 'error');
            } finally {
                showLoading(false);
                updateStatus('Ready');
            }
        }

        function applyFormula() {
            if (!AppState.selectedCell) {
                showNotification('Please select a cell first', 'error');
                return;
            }
            
            const formulaInput = document.getElementById('formulaInput');
            updateCell(AppState.selectedCell, formulaInput.value);
        }

        // ============================================
        // Save Functions
        // ============================================
        async function saveChanges() {
            if (!AppState.isDirty) {
                showNotification('No changes to save', 'success');
                return;
            }
            
            showLoading(true, 'Saving changes...');
            
            // In a real implementation, you would batch save all changes
            // For now, we'll just mark as saved
            
            setTimeout(() => {
                AppState.isDirty = false;
                showLoading(false);
                showNotification('Changes saved successfully', 'success');
                updateTimestamp();
            }, 1000);
        }

        // ============================================
        // Utility Functions
        // ============================================
        function columnToNumber(col) {
            let num = 0;
            for (let i = 0; i < col.length; i++) {
                num = num * 26 + (col.charCodeAt(i) - 64);
            }
            return num;
        }

        function numberToColumn(num) {
            let col = '';
            while (num > 0) {
                num--;
                col = String.fromCharCode(65 + (num % 26)) + col;
                num = Math.floor(num / 26);
            }
            return col;
        }

        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            loadingText.textContent = text;
            overlay.classList.toggle('active', show);
        }

        function updateStatus(message = 'Ready') {
            document.getElementById('status').textContent = message;
            
            if (message === 'Ready') {
                const cellCount = Object.keys(AppState.cells).length;
                const formulaCount = Object.keys(AppState.formulas).length;
                
                document.getElementById('cellCount').textContent = cellCount;
                document.getElementById('formulaCount').textContent = formulaCount;
            }
        }

        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = 
                'Last updated: ' + new Date().toLocaleTimeString();
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            text.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>